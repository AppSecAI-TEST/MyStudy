活动820后端魔豆接口测试
--

###案例：
0. 首页展示
1. 用户未登录
2. 用户登录，第一次领取
3. 用户登录，非第一次领取
4. 时间未到


###程序应有逻辑
0. 首页展示

> 分别尝试从缓存中取免单用户和魔豆获得者，获取不到则，免单从CMS处拉取，魔豆获得者从数据库拉取。

1. 用户未登录

> 通过`$this->ajax_user_auth ();`，进行校验，对未登录用户，返回1022状态码

2. 用户登录，第一次领取

> 先对缓存进行判断，如果缓存内不存在用户数据，即再次通过数据库进行校验，两步只要有一步未通过，则认为为已经领取，同时更新两边状态为同步(已领取)，同时返回1002状态码;确定
为第一次登录后，尝试进行魔豆分配。如果魔豆分配失败，返回1003状态码。如果成功，则进行更新DB,和缓存操作，(这边想做成事务，但是不知道怎么做。如果更新数据库成功，缓存失败，
可以删数据库，但是魔豆接口不知道如何进行回滚，这边默认都能成功)，在缓存中写入，同时设置失效时间为:**strtotime('tomorrow') - time()**，即今天还剩的时间。同时返回1001状态码，
同时带上获得的魔豆数

3. 用户登录，非第一次领取

> 取缓存，如果缓存内存在，则返回1002状态码，如果缓存内不存在，则进入数据库查询，如果存在记录，返回1002,同时更新缓存。

**PS: 以上操作如果时间未到，则跳转回首页**

###测试方法和结果
0. 将时间设为今天，和明天，看效果。

> **通过**

1. 退出登录，访问:[http://mogujie.com/webapp/event820/getmodou](http://mogujie.com/webapp/event820/getmodou)，返回1022

> **通过**

2. 登录，访问上述地址，返回1001

> **通过**

3. 再次访问，返回1002.删除缓存，再次访问，返回1002,删除缓存，删除数据库内容，再次访问，返回1001

> **通过**

4. 测试是否使用缓存，将所有使用到缓存的地方加上dd()，可知确实使用了缓存

> **通过**

###测试数据清除
访问：[http://mogujie.com/webapp/event820/testclear](http://mogujie.com/webapp/event820/testclear)，即可。**危险!上线后删除**
